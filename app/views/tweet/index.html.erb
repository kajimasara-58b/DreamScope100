<!DOCTYPE html>
<html>
<%= csrf_meta_tags %>
<link href="https://fonts.googleapis.com/css2?family=Aldrich&display=swap" rel="stylesheet">
<style>
  .tweet .bg-green-200 {
    background-color: #9AE6B4 !important; /* Tailwindのbg-green-200相当 */
    border-radius: 20px 20px 0 20px !important;
    margin-bottom: 0.5rem;
  }
  .tweet .bg-white {
    background-color: #FFFFFF !important; /* Tailwindのbg-white相当 */
    border-radius: 20px 20px 20px 0 !important;
    margin-bottom: 0.5rem;
  }
  .p-3.rounded-lg.max-w-xs.shadow {
    background-color: #FFFFFF; /* デフォルトを白 */
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  footer {
    margin-top: auto;
  }
  header h2 {
    font-family: 'Aldrich', sans-serif;
  }
  .link {
    transition: color 0.3s;
  }
  .link:hover {
    color: #E3E3E3;
  }
  .link:active {
    color: #A9A9A9;
  }
  #send-message {
    background-color: #FFA230;
    transition: background-color 0.3s;
  }
  #send-message:hover {
    background-color: #E6952A;
  }
  #send-message:active {
    background-color: #D98326;
  }
  .restricted-input {
    height: 50px;
    resize: none;
    white-space: normal;
    overflow-wrap: break-word;
    display: flex;
    align-items: center;
    padding: 6px;
  }
  .restricted-input::placeholder {
    font-size: 0.8rem;
    color: #999;
    white-space: normal;
    overflow-wrap: break-word;
  }
  .text-center.text-gray-500.text-sm.my-4 {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  .text-center.text-gray-500.text-sm.my-4::before,
  .text-center.text-gray-500.text-sm.my-4::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #d1d5db;
    margin: 0 10px;
  }
</style>

<body data-current-user-id="<%= @current_user.id %>">
<header class="fixed top-0 left-0 w-full bg-[#FFC276] text-white p-6 flex justify-between items-center">
  <h2 class="text-4xl"><%= link_to "DreamScope100", dashboard_index_path, class: "text-white link" %></h2>
  <%= link_to "ログアウト", destroy_user_session_path, data: { turbo_method: :delete }, class: "text-white link", onclick: "return confirm('ログアウトしますか？');" %>
</header>
<% if current_user.email_password_unset? %>
  <%= render "shared/flash" %>
<% end %>

<div class="bg-[#FFF5E8] flex flex-col h-screen">
  <div class="fixed top-20 left-0 w-full bg-[#FFF5E8] p-3 z-10">
    <div class="actions flex mr-5">
      <% breadcrumb :openchat %>
      <%= breadcrumbs separator: " › " %>
    </div>
  </div>

  <!-- チャットエリア（スクロール可能） -->
  <div id="tweets" class="flex-grow overflow-y-auto p-4" style="padding-top: 140px; padding-bottom: 160px;">
    <div class="max-w-md mx-auto flex flex-col space-y-2 justify-end min-h-full">
      <div id="messages">
        <% previous_date = nil %>
        <% @tweets.each do |tweet| %>
          <% current_date = tweet.created_at.in_time_zone('Tokyo').to_date %>
          <% if previous_date != current_date %>
            <div class="text-center text-gray-500 text-sm my-4" data-date="<%= current_date.to_s %>">
              <%= current_date.strftime("%Y/%m/%d") %>
            </div>
            <% previous_date = current_date %>
          <% end %>
          <%= render partial: "shared/message", locals: { tweet: tweet, is_current_user: (tweet.user_id == @current_user.id) } %>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 入力フォーム（固定） -->
  <div class="fixed bottom-14 left-0 w-full bg-[#FFF5E8] z-10 p-4">
    <div class="max-w-md mx-auto flex items-center space-x-2">
      <%= label_tag :message, 'Say something:', class: "sr-only" %>
      <% if current_user.email_password_unset? %>
        <%= text_area_tag :message, nil, placeholder: "※メールアドレス・パスワードを設定するとメッセージを送信できます", class: "flex-grow border rounded p-2 restricted-input", readonly: true, rows: 2 %>
      <% else %>
        <%= text_field_tag :message, nil, data: { behavior: 'room_speaker' }, class: "flex-grow border rounded p-2", id: "message-input" %>
      <% end %>
      <% unless current_user.email_password_unset? %>
        <button id="send-message" class="bg-blue-500 text-white px-4 py-2 rounded">送信</button>
      <% end %>
    </div>
  </div>
  <div class="fixed bottom-0 left-0 w-full z-0">
    <footer class="fixed bottom-0 left-0 w-full bg-[#FFC276] text-white p-4 flex justify-between">
      <div>
        <%= link_to 'プライバシーポリシー', privacypolicy_index_path, class: "text-white link" %>
        <%= link_to '利用規約', riyoukiyaku_index_path, class: "text-white link" %>
        <%= link_to 'お問い合わせ', new_public_contact_path, class: "text-white link" %>
      </div>
      <p>© 2025 DreamScope100. All rights reserved.</p>
    </footer>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function scrollToBottom() {
    const tweetsContainer = document.getElementById('tweets');
    if (tweetsContainer) {
      tweetsContainer.scrollTop = tweetsContainer.scrollHeight;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(scrollToBottom, 100);
  });

  document.addEventListener('turbo:load', () => {
    const currentUserId = document.querySelector('body')?.dataset.currentUserId?.toString();
    console.log("turbo:load - Current User ID:", currentUserId);
    if (!currentUserId) {
      console.error("turbo:load - currentUserId is missing!");
    }
    setTimeout(scrollToBottom, 100);

    // 送信ボタンのクリックイベントを明示的に定義
    const sendButton = document.getElementById('send-message');
    if (sendButton) {
      sendButton.onclick = function() {
        const messageInput = document.getElementById('message-input');
        if (messageInput && messageInput.value.trim()) {
          const channel = consumer.subscriptions.subscriptions[0];
          if (channel) {
            channel.perform('speak', { message: messageInput.value.trim() });
            messageInput.value = '';
          }
        }
        return false; // デフォルト動作を防ぐ
      };
    }
  });
</script>
</body>
</html>