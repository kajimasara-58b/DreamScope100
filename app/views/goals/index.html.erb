<!DOCTYPE html>
<html>
<style>
  .button {
    transition: background-color 0.3s, color 0.3s; /* ã‚¹ãƒ ãƒ¼ã‚ºãªãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
  }

  .button:hover {
    background-color: #f0f0f0; /* ãƒ›ãƒãƒ¼æ™‚ã®èƒŒæ™¯è‰² */
    color: #333; /* ãƒ›ãƒãƒ¼æ™‚ã®æ–‡å­—è‰² */
  }

  .button:active {
    background-color: #e0e0e0; /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®èƒŒæ™¯è‰² */
    color: #111; /* ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æ–‡å­—è‰² */
  }
  .goal-number {
    font-family: 'Aldrich', sans-serif; /* Aldrichãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®š */
    color: #FFA230; /* è‰²ã‚’æŒ‡å®š */
  }
  /* ä¸¦ã³æ›¿ãˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
  .sort-menu {
    display: none;
    position: absolute;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    width: 180px;
  }

  .sort-menu a {
    display: block;
    padding: 8px 12px;
    text-decoration: none;
    color: black;
  }

  .sort-menu a:hover {
    background-color: #f0f0f0;
  }

  .category-button {
    display: inline-block;
    padding: 3px 6px; /* ãƒœã‚¿ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å°ã•ã */
    border-radius: 5px;
    color: #4E4D4D; /* æ–‡å­—è‰²ã‚’ç™½ã«å¤‰æ›´ */
    font-size: 12px; /* æ–‡å­—ã®å¤§ãã•ã‚’å°ã•ã */
    margin-left: 10px; /* ãƒœã‚¿ãƒ³ã¨ç›®æ¨™ã‚¿ã‚¤ãƒˆãƒ«ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
    white-space: nowrap; /* æ–‡å­—ã‚’æŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã«ã™ã‚‹ */
  }  

  .å¥åº· {
    background-color: #D4F2C4;
  }

  .ç¾å®¹ {
    background-color: #FFDADA;
  }

  .é‹å‹•ãƒ»ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ {
    background-color: #B3D8C6;
  }

  .ä»•äº‹ {
    background-color: #D0E2F3;
  }

  .å­¦ç¿’ {
    background-color: #B7C4F9;
  }

  .ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ« {
    background-color: #FDB5B6;
  }

  .æ—…è¡Œãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ {
    background-color: #FFBC9D;
  }

  .ãŠé‡‘ï¼ˆè²¯é‡‘ãƒ»æŠ•è³‡ãƒ»è³‡ç”£å½¢æˆãªã©ï¼‰ {
    background-color: #FEDD91;
  }

  .äººé–“é–¢ä¿‚ï¼ˆå®¶æ—ãƒ»å‹äººãƒ»æ‹æ„›ãªã©ï¼‰ {
    background-color: #E2B4FF;
  }

  .ãã®ä»– {
    background-color: #D0CECE;
  }

  .dialog {
    max-height: 80vh;
  }
  .image-container {
    max-height: 50vh;
    overflow: auto;
  }
  .preview-image {
    max-width: 100% !important;
    max-height: 50vh !important;
    object-fit: contain;
    width: auto;
    height: auto;
  }
  /* å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #image-preview .shadow-xl {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
  }

  #share-twitter {
    background-color: #333;
    transition: background-color 0.3s ease;
  }
</style>

<%= render "shared/header" %>

<p style="color: green"><%= notice %></p>

<body class="bg-[#FFF5E8] flex flex-col h-screen overflow-auto">

  <main class="flex-grow p-4 flex-col md:flex-row" style="display: flex; flex-direction: column;">
    <div class="actions mb-5 flex mr-5">
      <% breadcrumb :goals_index %>
      <%= breadcrumbs separator: " &rsaquo; " %>
    </div>
    <div class="actions mb-5 flex mr-5">
      <form method="GET" action="<%= request.path %>">
        <div class="bg-white text-black flex items-center px-4 py-2 rounded shadow">
          <i class="fas fa-sort mr-2"></i>
          <label for="sort-select" class="mr-2">ä¸¦ã³æ›¿ãˆ:</label>
          <select id="sort-select" name="sort" onchange="this.form.submit()">
            <option value="id" <%= "selected" if params[:sort] == "id" %>>ç™»éŒ²é †</option>
            <option value="due_date" <%= "selected" if params[:sort] == "due_date" %>>é”æˆäºˆå®šæ—¥ãŒè¿‘ã„é †</option>
            <option value="status" <%= "selected" if params[:sort] == "status" %>>é”æˆçŠ¶æ³åˆ¥</option>
            <option value="category" <%= "selected" if params[:sort] == "category" %>>ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
          </select>
        </div>
      </form> 
      <%= link_to "/goals/new", class: "ml-4 bg-white text-black flex items-center px-4 py-2 rounded shadow button" do %>
        <i class="fas fa-pencil-alt mr-2"></i>ç›®æ¨™ä½œæˆ
      <% end %>
      <a href="#" id="generate-image-button" class="ml-4 bg-white text-black flex items-center px-4 py-2 rounded shadow button">
        <i class="fas fa-image mr-2"></i>ç”»åƒç”Ÿæˆ
      </a>
    </div>

    <div id="image-preview" style="display: none;" class="fixed inset-0 w-full flex items-center justify-center bg-black/50 dialog">
      <div class="bg-white p-6 rounded-lg shadow text-center max-w-md max-h-[80vh] overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">ç”Ÿæˆã•ã‚ŒãŸç”»åƒ</h3>
        <div class="mb-6 image-container">
          <img id="preview-image" class="max-w-full block border border-gray-300" alt="Generated Image">
        </div>
        <div class="mt-10">
          <a id="share-twitter" class="bg-[#FFFFFF] text-white items-center px-4 py-2 rounded shadow">
            <i class="fa-brands fa-x-twitter fa-xl mr-2"></i> ã‚·ã‚§ã‚¢ã™ã‚‹
          </a>
        </div>
        <div class="mt-4">
          <button id="close-preview" class="text-gray-500 underline">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  
    <script>
    document.addEventListener("turbo:load", () => {
      const button = document.getElementById("generate-image-button");
      const preview = document.getElementById("image-preview");
      const image = document.getElementById("preview-image");
      const twitterButton = document.getElementById("share-twitter");
      const closeButton = document.getElementById("close-preview");
      closeButton.addEventListener("click", () => {
        preview.style.display = "none";
      });

      button.addEventListener("click", (e) => {
        e.preventDefault();

        // ---- ã“ã“ã‹ã‚‰Canvasä½œæˆã™ã‚‹å‡¦ç† ----
        const canvas = document.createElement('canvas');
        canvas.width = 794;
        canvas.height = 1123;
        const ctx = canvas.getContext('2d');
    
        // èƒŒæ™¯ã‚’ç™½ã«å¡—ã‚‹
        ctx.fillStyle = "#FFF5E8";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    
        // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
        ctx.fillStyle = "#000000";
        ctx.font = "16px sans-serif";
        ctx.textBaseline = "top";
    
        // ã“ã“ã«ç›®æ¨™ä¸€è¦§ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹å‡¦ç†ã‚’æ›¸ã
        const goals = [...document.querySelectorAll('.goal-item')].map(el => {
          const titleLink = el.querySelector('a.goal-title');
          return titleLink ? titleLink.textContent.trim() : "";
        });
    
        goals.forEach((goal, index) => {
          const col = index < 50 ? 0 : 1; // å·¦åˆ— or å³åˆ—
          const row = index % 50;         // ä½•è¡Œç›®ã‹
          const x = col === 0 ? 40 : 400;  // å·¦åˆ—:40pxã€å³åˆ—:400pxã‚¹ã‚¿ãƒ¼ãƒˆ
          const y = 40 + row * 20;         // ä¸Šã‹ã‚‰40pxã€1è¡Œ20pxé–“éš”
          ctx.fillText(`${index + 1}. ${goal}`, x, y);
        });
    
        // Canvasã‹ã‚‰Base64ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        const imageData = canvas.toDataURL('image/png');
    
        // ---- ã“ã“ã¾ã§Canvasä½œæˆã™ã‚‹å‡¦ç† ----
    
        // ä½œã£ãŸç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«è¡¨ç¤º
        image.src = imageData;
        preview.style.display = "flex"

        image.onload = () => {
          const imageContainer = image.parentElement;
          console.log("ç”»åƒã®å¹…:", image.width, "é«˜ã•:", image.height);
          console.log("ã‚³ãƒ³ãƒ†ãƒŠã®å¹…:", imageContainer.clientWidth, "é«˜ã•:", imageContainer.clientHeight);
        };    

        // ç”»åƒèª­ã¿è¾¼ã¿å¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã‚’èª¿æ•´
        image.onload = () => {
          const imageContainer = image.parentElement;
          imageContainer.scrollTop = 0; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        };

        const tweetText = encodeURIComponent("ç›®æ¨™é”æˆã«å‘ã‘ã¦ãŒã‚“ã°ã£ã¦ã„ã¾ã™ï¼ğŸ’ª");
        const url = encodeURIComponent(window.location.href);
        twitterButton.href = `https://twitter.com/intent/tweet?text=${tweetText}&url=${url}`;
      })
      .catch(error => {
        console.error("ç”»åƒç”Ÿæˆå¤±æ•—", error);
      });
    });
    </script>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
      <% 
        sorted_goals = case params[:sort]
          when "category"
            @goals.order(:category)
          when "due_date"
            @goals.order(:due_date)
          when "status"
            @goals.order(:status)
          else
            @goals.order(:id)
        end
      %>
      <% goals_count = sorted_goals.count %> <!-- ç¾åœ¨ã®ç›®æ¨™æ•° -->
      <% current_index = 1 %>

      <!-- ç¾åœ¨ã®ç›®æ¨™ã‚’è¡¨ç¤º -->
      <% sorted_goals.each do |goal| %>
        <div class="flex items-center goal-item">
          <span class="mr-2 goal-number"><%= current_index %></span>
          <%= check_box_tag "goals[]", goal.id, goal.status == "æ¸ˆ", disabled: true %>
          <%= link_to goal.title, goal_path(goal), class: "ml-2 cursor-pointer goal-title" %>
          
          <% if params[:sort] == "category" %>
            <span class="category-button <%= goal.category %>"><%= goal.category %></span>
          <% end %>
        </div>
        <% current_index += 1 %>
      <% end %>

      <!-- æ®‹ã‚Šã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ã€Œæ–°ã—ã„ç›®æ¨™ã‚’ä½œæˆã€ã§åŸ‹ã‚ã‚‹ï¼ˆæœ€å¤§100ã¾ã§ï¼‰ -->
      <% (goals_count + 1..100).each do |num| %>
        <div class="flex items-center">
          <span class="mr-2 goal-number"><%= current_index %></span>
          <%= check_box_tag "goals[]", nil, false, disabled: true %>
          <%= link_to "æ–°ã—ã„ç›®æ¨™ã‚’ä½œæˆ", new_goal_path, class: "ml-2 cursor-pointer text-gray-300" %>
        </div>
        <% current_index += 1 %>
      <% end %>
    </div>
  </main>
</body>

<%= render "shared/footer" %>

<!-- Font Awesomeã®CDNã‚’èª­ã¿è¾¼ã‚€ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<script>
  document.getElementById('sort-button').addEventListener('click', function() {
    let menu = document.getElementById('sort-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  });

  document.addEventListener('click', function(event) {
    let sortButton = document.getElementById('sort-button');
    let sortMenu = document.getElementById('sort-menu');
    if (!sortButton.contains(event.target) && !sortMenu.contains(event.target)) {
      sortMenu.style.display = 'none';
    }
  });
</script>

</html>
