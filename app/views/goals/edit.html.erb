<!DOCTYPE html>
<html>
<head>
<style>
  <!-- Turboのキャッシュを無効化 -->
  <meta name="turbo-cache-control" content="no-cache">

  .button {
    transition: background-color 0.3s, color 0.3s; /* スムーズなトランジション */
  }

  .button:hover {
    background-color: #f0f0f0; /* ホバー時の背景色 */
    color: #333; /* ホバー時の文字色 */
  }

  .button:active {
    background-color: #e0e0e0; /* クリック時の背景色 */
    color: #111; /* クリック時の文字色 */
  }

  .calendar-icon {
    color: #FFC276;
    transition: color 0.3s;
  }

  .calendar-icon:hover {
    color: #FFA230;
  }

  .form-uniform-height {
    height: 42px;
    line-height: 42px;
  }
  .text-right-force {
    text-align: right !important;
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    margin-right: 24px; /* ONと「何日前」の間隔を広げる */
    margin-left: 8px;
  }
  .checkbox-label {
    margin-left: 10px;
    margin-bottom: 0;
  }
  .days-input {
    width: 70px; /* 何日前の入力幅 */
    border-radius: 4px;
    text-align: right;
  }
  .text_nitimae {
    width: 55px;
  }
  .form-section {
    width: 50%; /* 半分ずつ */
  }
</style>
</head>

<%= render "shared/header" %>

<%= render 'devise/shared/error_messages', resource: @goal %>

<body class="bg-[#FFF5E8] flex flex-col h-screen overflow-auto" data-page="goal-edit">
  <div class="flex-grow p-4 flex-col md:flex-row" style="display: flex; flex-direction: column;">  
    <div class="actions mb-7 flex mr-5">
      <% breadcrumb :goal_edit %>
      <%= breadcrumbs separator: " › " %>
    </div>
    <main class="flex-grow p-4 flex flex-col items-center justify-center">
      <%= form_with model: @goal, local: true, html: { class: "w-full max-w-md" } do |form| %>
        <div class="mb-4">
          <%= form.label :title, "目標" %>
          <%= form.text_area :title, placeholder: "目標を入力してください", required: true, class: "rounded w-full py-2 px-3", id: "goal-title-input-edit" %>
          <div class="text-sm text-gray-500 mt-1">
            <span id="title-char-count-edit">0</span>/40
          </div>
        </div>

        <div>
          <%= form.label :due_date, "達成予定日" %>
        </div>
        <div class="mb-4 flex items-center space-x-2">
          <%= form.date_field :due_date, class: "rounded w-full py-2 px-3 mr-3 form-uniform-height", id: "goal-due-date-input-edit"%>
          <button type="button" onclick="addToGoogleCalendar()" class="flex items-center cursor-pointer" title="Googleカレンダーに追加">
            <i class="fas fa-calendar-plus text-3xl mr-2 calendar-icon"></i>
          </button>
        </div>

        <div class="mb-4 flex gap-x-8">
          <div class="w-1/2 mr-5 form-section">
            <%= form.label :status, "達成状況" %>
            <%= form.select :status, Goal.statuses.keys.map { |status| [status.humanize, status] }, { prompt: '選択してください' }, { class: "rounded p-2 w-full form-uniform-height" } %>
          </div>

          <div class="w-1/2 form-section">
            <%= form.label :notify_enabled, "通知設定" %>
            <div class="flex items-center rounded bg-white p-2 form-uniform-height">
              <!-- 隠しフィールドを追加 -->
              <%= form.hidden_field :notify_enabled, value: "0" %>
              <!-- ONチェックボックス -->
              <div class="checkbox-group">
                <%= form.check_box :notify_enabled, { class: "" }, "1", "0" %>
                <%= form.label :notify_enabled, "ON", class: "checkbox-label" %>
              </div>

              <!-- 通知何日前フォーム + 日前 -->
              <div class="flex items-center gap-x-1">
                <%= form.number_field :notify_days_before, min: 1, placeholder: "", class: "days-input" %>
              </div>
              <div class="text_nitimae">
                <span>日前</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-9">
          <%= form.label :category, "カテゴリー" %>
          <%= form.select :category, Goal.categories.keys.map { |category| [category.humanize, category] }, { prompt: '選択してください' }, { class: "rounded w-full py-2 px-3 form-uniform-height" } %>
        </div>

        <div class="flex flex-col justify-center items-center md:items-start mb-5">
          <div class="flex mb-5 justify-between w-full">
            <div class="actions mb-5 flex mr-5">
              <%= link_to "キャンセル", goal_path, class: "bg-gray-300 text-black flex items-center px-4 py-2 rounded shadow button" %>
            </div>
            <div class="actions mb-5 flex">
              <%= form.submit "更新", class: "bg-white text-black flex items-center px-4 py-2 rounded shadow button cursor-pointer" %>
            </div>
          </div>
        </div>
      <% end %>
    </main>
  </div>

  <!-- 文字数カウント用のスクリプト -->
  <script>
    const initializeCharCountEdit = () => {
      // 編集画面でのみ実行
      if (document.body.dataset.page !== "goal-edit") return;

      const titleInput = document.getElementById("goal-title-input-edit");
      const charCountDisplay = document.getElementById("title-char-count-edit");

      if (!titleInput || !charCountDisplay) return; // 要素が存在しない場合はスキップ

      // 文字数を更新する関数
      const updateCharCount = () => {
        const charCount = titleInput.value.length;
        charCountDisplay.textContent = charCount;
        if (charCount > 40) {
          charCountDisplay.style.color = "red";
        } else {
          charCountDisplay.style.color = "gray";
        }
      };

      // 初期文字数を設定
      updateCharCount();

      // 入力時のリアルタイム更新
      titleInput.addEventListener("input", updateCharCount);
    };

    function generateGoogleCalendarLink(title, date, description = "DreamScope100からの目標") {
      const parsedDate = new Date(date);
      if (isNaN(parsedDate)) {
        throw new Error("無効な日付です。正しい日付を入力してください。");
      }

      const formattedDate = parsedDate.toISOString().replace(/[-:]/g, "").split(".")[0].slice(0, 8);
      const encodedTitle = encodeURIComponent(title);
      const encodedDescription = encodeURIComponent(description);
      const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodedTitle}&dates=${formattedDate}/${formattedDate}&details=${encodedDescription}`;
      return url;
    }

    function addToGoogleCalendar() {
      const originalTitle = document.getElementById("goal-title-input-edit").value.trim();
      const title = `達成予定日：${originalTitle}`;
      const date = document.getElementById("goal-due-date-input-edit").value;

      if (!originalTitle) {
        alert("目標を入力してください！");
        return;
      }
      if (!date) {
        alert("達成予定日を選択してください！");
        return;
      }

      // 古い予定の削除を促すアラート
      alert("Googleカレンダーで古い予定（「" + title + "」）を削除してください。");

      try {
        const calendarUrl = generateGoogleCalendarLink(title, date);
        window.open(calendarUrl, "_blank");
      } catch (error) {
        alert(error.message);
      }
    };

    // Turboのレンダリング後に実行
    document.addEventListener("turbo:render", initializeCharCountEdit);
    // 初回ロード時にも実行
    document.addEventListener("turbo:load", initializeCharCountEdit);
  </script>
</body>

<%= render "shared/footer" %>

<!-- Font AwesomeのCDNを読み込む -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

</html>