<!DOCTYPE html>
<html>
<head>
  <!-- Turboのキャッシュを無効化 -->
  <meta name="turbo-cache-control" content="no-cache">
</head>

<%= render "shared/header" %>

<%= render 'devise/shared/error_messages', resource: @goal %>

<body class="bg-[#FFF5E8] flex flex-col h-screen overflow-auto" data-page="goal-edit">
  <div class="flex-grow p-4 flex-col md:flex-row" style="display: flex; flex-direction: column;">  
    <div class="actions mb-7 flex mr-5">
      <% breadcrumb :goal_edit %>
      <%= breadcrumbs separator: " › " %>
    </div>
    <main class="flex-grow p-4 flex flex-col items-center justify-center">
      <%= form_with model: @goal, local: true, html: { class: "w-full max-w-md" } do |form| %>
        <div class="mb-4">
          <%= form.label :title, "目標" %>
          <%= form.text_area :title, placeholder: "目標を入力してください", required: true, class: "rounded w-full py-2 px-3", id: "goal-title-input-edit" %>
          <div class="text-sm text-gray-500 mt-1">
            <span id="title-char-count-edit">0</span>/40
          </div>
        </div>

        <div class="mb-4">
          <%= form.label :due_date, "達成予定日" %>
          <%= form.date_field :due_date, class: "rounded w-full py-2 px-3" %>
        </div>

        <div class="mb-4">
          <%= form.label :status, "達成状況" %>
          <%= form.select :status, Goal.statuses.keys.map { |status| [status.humanize, status] }, { prompt: '選択してください' }, { class: "rounded w-full py-2 px-3" } %>
        </div>

        <div class="mb-9">
          <%= form.label :category, "カテゴリー" %>
          <%= form.select :category, Goal.categories.keys.map { |category| [category.humanize, category] }, { prompt: '選択してください' }, { class: "rounded w-full py-2 px-3" } %>
        </div>

        <div class="flex flex-col justify-center items-center md:items-start mb-5">
          <div class="flex mb-5 justify-between w-full">
            <div class="actions mb-5 flex mr-5">
              <%= link_to "キャンセル", goal_path, class: "bg-gray-300 text-black flex items-center px-4 py-2 rounded shadow button" %>
            </div>
            <div class="actions mb-5 flex">
              <%= form.submit "更新", class: "bg-white text-black flex items-center px-4 py-2 rounded shadow button" %>
            </div>
          </div>
        </div>
      <% end %>
    </main>
  </div>

  <!-- 文字数カウント用のスクリプト -->
  <script>
    const initializeCharCountEdit = () => {
      // 編集画面でのみ実行
      if (document.body.dataset.page !== "goal-edit") return;

      const titleInput = document.getElementById("goal-title-input-edit");
      const charCountDisplay = document.getElementById("title-char-count-edit");

      if (!titleInput || !charCountDisplay) return; // 要素が存在しない場合はスキップ

      // 文字数を更新する関数
      const updateCharCount = () => {
        const charCount = titleInput.value.length;
        charCountDisplay.textContent = charCount;
        if (charCount > 40) {
          charCountDisplay.style.color = "red";
        } else {
          charCountDisplay.style.color = "gray";
        }
      };

      // 初期文字数を設定
      updateCharCount();

      // 入力時のリアルタイム更新
      titleInput.addEventListener("input", updateCharCount);
    };

    // Turboのレンダリング後に実行
    document.addEventListener("turbo:render", initializeCharCountEdit);
    // 初回ロード時にも実行
    document.addEventListener("DOMContentLoaded", initializeCharCountEdit);
  </script>
</body>

<%= render "shared/footer" %>

<!-- Font AwesomeのCDNを読み込む -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

</html>